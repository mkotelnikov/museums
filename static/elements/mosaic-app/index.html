<link rel="import" href="../../libs/polymer/polymer.html" />
<link rel="import" href="../../libs/paper-button/paper-button.html">
<link rel="import" href="../../libs/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../libs/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../libs/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../libs/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../libs/paper-input/paper-input.html">

<link rel="import" href="../../libs/iron-icons/iron-icons.html">
<link rel="import" href="../../libs/paper-styles/color.html">
<link rel="import" href="../../libs/iron-icon/iron-icon.html">

<link rel="import" href="../mosaic-map/index.html">
<link rel="import" href="../mosaic-map-marker/index.html">
<link rel="import" href="../mosaic-map-tiles/index.html">

<script type="text/javascript" src="../../libs/mosaic-state/dist/index.js"></script>
<script type="text/javascript" src="../../libs/mosaic-webcomponents/ActiveFields.js"></script>
<script type="text/javascript" src="../../libs/mosaic-webcomponents/AppBehavior.js"></script>
<script type="text/javascript" src="../../libs/mosaic-webcomponents/AppComponentBehavior.js"></script>

<dom-module id="mosaic-app-component">
<style>
:host {
    display: block;
    width: 100%;
    height: 100%;
}
[main] {
}

[drawer] {
    background-color: #eee;
}
paper-input {
    color: white;
}
  
</style>

<template>
<paper-drawer-panel>

  <paper-header-panel drawer right-drawer>
    <paper-toolbar>
      <h1>Mosaic Maps</h1>
    </paper-toolbar>
    
    <div> Drawer content... </div>
  </paper-header-panel>
  
  <paper-header-panel main>
    <paper-toolbar>
      <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
      <div>
            <paper-input label="Search" value="{{queryInput}}">
              <iron-icon icon="search" prefix></iron-icon>
              <paper-icon-button suffix icon="clear"></paper-icon-button>
            </paper-input>
      </div>
    </paper-toolbar>
    <mosaic-map zoom="{{mapInfo.zoom}}"
        center="{{mapInfo.center}}" min-zoom="1" max-zoom="18">
    
        <mosaic-map-tiles tiles-url="tiles/tiles-world/{z}/{x}/{y}/tile.png">
        </mosaic-map-tiles>
    
        <mosaic-map-tiles
            tiles-url="{{locale.lang}}/museums/tilestyle-museum/{z}/{x}/{y}/tile.png?query={{querySerialized}}"
            utfgrid-url="{{locale.lang}}/museums/tilestyle-museum/{z}/{x}/{y}/tile.utf.json?query={{querySerialized}}&cb={cb}"
            on-click="_handleClick">
        </mosaic-map-tiles>
        
        <template is="dom-if" if="{{marker.data}}" restamp>
            <mosaic-map-marker position="{{marker.position}}"
                icon-url="./libs/leaflet/dist/images/marker-icon.png"
                icon-size="[ 32, 48 ]" icon-anchor="[ 16, 48 ]"
                popup-anchor="[ 0, -50 ]"
                show-popup
                data="{{marker.data}}">
                    <div style="min-width: 150px">
                        <h3>
                            <span class="name">{{marker.data.name}}</span> (<span
                                class="abbrev">{{marker.data.category}}</span>)
                        </h3>
                    </div>
            </mosaic-map-marker>
        </template>
    
    </mosaic-map>
  </paper-header-panel>
  
</paper-drawer-panel>

</template>
<script>
    Polymer({
        is : 'mosaic-app-component',
        behaviors : [ AppComponentBehavior, ActiveFields.Behavior ],
        properties : ActiveFields({
            mapInfo : {
                type : Object,
                fields : {
                    center : 'map.center',
                    zoom : 'map.zoom'
                }
            },
            marker : {
                type : Object,
                fields : {
                    position : 'map.marker.position',
                    data : 'map.marker.data',
                }
            },
            locale : {
                type : Object,
                fields : {
                    lang : 'lang'
                }
            },
            querySerialized : {
                value  : JSON.stringify({q : ''})   
            },
            query : {
                type : Object,
                fields : {
                    q : 'query.q'
                },
            },
            queryInput : {
                type : Object,
                observer : '_onQueryInputChanged'
            }
        }),
        ready : function(){
        },
        attached : function() {
            this.locale.lang = 'french';
            this.mapInfo.center = [ 2.309875, 48.883908 ];
            this.mapInfo.zoom = 12;
            this.marker.position = this.mapInfo.center;
        },
        _handleClick : function(ev) {
            var latlng = ev.detail.latlng;
            if (!latlng)
                return;
            var data = ev.detail.data;
            if (data){
                var coords = [ latlng.lng, latlng.lat ];
                this.mapInfo.center = coords;
                this.marker.position = coords;
            }
            this.marker.data = data;
        },
        onComponentAdd : function(state) {
            this.initActiveFields(state);
            state.addListener(function(ev) {
                var s = state.state();
                console.log('>>', JSON.stringify(s, null, 2));
                
                this.querySerialized = JSON.stringify(s.query);
                console.log('????', this.querySerialized);
            }.bind(this))
        },

        onComponentRemove : function(state) {
            this.clearActiveFields(state);
        },
        
        _onQueryInputChanged : function(value){
            var q = value;
            if (q) { q += ':*'; }
            this.query.q = q;
        },
    });
</script> </dom-module>

<dom-module id="mosaic-app">
<template>
    <mosaic-app-component />
</template>
<script>
    Polymer({
        is : 'mosaic-app',
        behaviors : [ AppBehavior ],
    });
</script> </dom-module>
